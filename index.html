<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AR Restroom Locator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }
        
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        #video.active {
            opacity: 1;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            pointer-events: none;
        }
        
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 3;
            pointer-events: none;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            color: white;
            padding: 25px;
            border-radius: 20px;
            border: 3px solid rgba(0, 255, 255, 0.4);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            animation: glow 2s infinite alternate;
        }
        
        .distance-display {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            color: #00ffff;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
            animation: pulse 2s infinite;
        }
        
        .direction-display {
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
            color: #ffffff;
            font-weight: 500;
        }
        
        .mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s ease;
        }
        
        .mode-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .compass-container {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 120px;
            height: 120px;
            border: 4px solid rgba(0, 255, 255, 0.6);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
        }
        
        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 50px;
            background: linear-gradient(to top, #ff0000, #ff6666);
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            border-radius: 3px;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            animation: needle-glow 1.5s infinite alternate;
        }
        
        .compass-labels {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        .compass-n { position: absolute; top: 8px; left: 50%; transform: translateX(-50%); }
        .compass-e { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); }
        .compass-s { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); }
        .compass-w { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); }
        
        .navigation-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            color: white;
            padding: 20px;
            border-radius: 15px;
            border: 3px solid rgba(0, 255, 0, 0.4);
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        .coordinates {
            font-size: 12px;
            margin-top: 10px;
            color: #aaa;
        }
        
        .control-buttons {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }
        
        .start-button {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.4);
            transition: all 0.3s ease;
            animation: button-pulse 2s infinite;
        }
        
        .start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.6);
        }
        
        .camera-button {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }
        
        .camera-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
            z-index: 10;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid rgba(0, 255, 255, 0.5);
        }
        
        .arrived-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: white;
            padding: 40px;
            border-radius: 25px;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            display: none;
            z-index: 10;
            box-shadow: 0 0 40px rgba(0, 255, 0, 0.6);
            animation: celebration 0.5s ease-in-out;
        }
        
        .no-camera-mode {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid rgba(0, 255, 255, 0.5);
            max-width: 80%;
        }
        
        .radar-container {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border: 3px solid rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            position: relative;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
        }
        
        .radar-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff0000;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: radar-pulse 2s infinite;
        }
        
        .radar-sweep {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 95px;
            background: linear-gradient(to top, transparent, rgba(0, 255, 255, 0.8));
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            animation: radar-sweep 3s linear infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 30px rgba(0, 255, 255, 0.3); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.6); }
        }
        
        @keyframes needle-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 0, 0, 0.6); }
            50% { box-shadow: 0 0 25px rgba(255, 0, 0, 0.9); }
        }
        
        @keyframes button-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes celebration {
            0% { transform: translate(-50%, -50%) scale(0.8); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes radar-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.5; }
        }
        
        @keyframes radar-sweep {
            0% { transform: translate(-50%, -100%) rotate(0deg); }
            100% { transform: translate(-50%, -100%) rotate(360deg); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes restroom-glow {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>üöÄ Initializing AR System...</div>
        <div style="font-size: 16px; margin-top: 15px;">Please allow location access</div>
    </div>
    
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    
    <div class="ui-overlay">
        <div class="info-panel">
            <div class="distance-display" id="distanceDisplay">üöª Restroom: Locating...</div>
            <div class="direction-display" id="directionDisplay">Initializing compass...</div>
        </div>
        
        <button class="mode-toggle" id="modeToggle" onclick="toggleMode()">üì± Map Mode</button>
        
        <div class="compass-container" id="compassContainer">
            <div class="compass-needle" id="compassNeedle"></div>
            <div class="compass-labels">
                <div class="compass-n">N</div>
                <div class="compass-e">E</div>
                <div class="compass-s">S</div>
                <div class="compass-w">W</div>
            </div>
        </div>
        
        <div class="navigation-info" id="navigationInfo">
            <div id="modeText">Move your phone to look around</div>
            <div class="coordinates" id="coordinates">Waiting for GPS...</div>
        </div>
        
        <div class="control-buttons">
            <button class="start-button" id="startButton" onclick="startTracking()">üöÄ Start Navigation</button>
            <button class="camera-button" id="cameraButton" onclick="toggleCamera()">üì∑ AR Camera</button>
        </div>
    </div>
    
    <div class="no-camera-mode hidden" id="noCameraMode">
        <h2>üöª Restroom Locator</h2>
        <div class="radar-container">
            <div class="radar-sweep"></div>
            <div class="radar-dot" id="radarDot"></div>
        </div>
        <div id="radarInfo">Distance: Calculating...</div>
    </div>
    
    <div class="arrived-message" id="arrivedMessage">
        üéâ DESTINATION REACHED! üéâ<br>
        <div style="font-size: 18px; margin-top: 15px;">Welcome to the restroom!</div>
    </div>

    <script>
        class EnhancedARRestroomLocator {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.video = null;
                this.canvas = null;
                
                // Real device sensors
                this.currentPosition = { lat: 0, lng: 0, accuracy: 0 };
                this.initialPosition = { lat: 0, lng: 0 };
                this.deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
                this.compassHeading = 0;
                
                // Restroom location
                this.restroomLocation = {
                    lat: 0,
                    lng: 0,
                    name: "Nearby Restroom"
                };
                
                // 3D objects
                this.restroomMarker = null;
                this.restroomSymbol = null;
                this.directionArrow = null;
                this.pathLine = null;
                
                // State
                this.isActive = false;
                this.cameraMode = false;
                this.currentDistance = 0;
                this.targetBearing = 0;
                this.hasArrived = false;
                this.destinationSet = false;
                this.animationId = null;
                
                this.init();
            }
            
            init() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.setupThreeJS();
                this.setupEventListeners();
            }
            
            setupThreeJS() {
                this.scene = new THREE.Scene();
                
                this.camera = new THREE.PerspectiveCamera(
                    75, 
                    window.innerWidth / window.innerHeight, 
                    0.1, 
                    1000
                );
                
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: this.canvas,
                    alpha: true,
                    antialias: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setClearColor(0x000000, 0);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // Enhanced lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(0, 10, 5);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);
                
                // Add point light for restroom symbol
                const pointLight = new THREE.PointLight(0x00ffff, 1, 100);
                pointLight.position.set(0, 5, 0);
                this.scene.add(pointLight);
                
                this.create3DObjects();
            }
            
            create3DObjects() {
                // Create LARGE bouncing restroom symbol
                const symbolGroup = new THREE.Group();
                
                // Main restroom building
                const buildingGeometry = new THREE.BoxGeometry(4, 6, 3);
                const buildingMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x00ffff,
                    transparent: true,
                    opacity: 0.9,
                    emissive: 0x002222
                });
                const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
                building.castShadow = true;
                symbolGroup.add(building);
                
                // Restroom sign
                const signGeometry = new THREE.PlaneGeometry(3, 1.5);
                const signMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.9
                });
                const sign = new THREE.Mesh(signGeometry, signMaterial);
                sign.position.set(0, 2, 1.6);
                symbolGroup.add(sign);
                
                // Floating icons above
                const iconGeometry = new THREE.SphereGeometry(0.5, 8, 8);
                const iconMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xff6600,
                    emissive: 0x331100
                });
                
                for (let i = 0; i < 3; i++) {
                    const icon = new THREE.Mesh(iconGeometry, iconMaterial);
                    icon.position.set(
                        (i - 1) * 1.5, 
                        8 + Math.sin(i) * 2, 
                        0
                    );
                    symbolGroup.add(icon);
                }
                
                this.restroomSymbol = symbolGroup;
                this.scene.add(this.restroomSymbol);
                
                // Create direction arrow
                const arrowGeometry = new THREE.ConeGeometry(0.8, 3, 8);
                const arrowMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xff0000,
                    emissive: 0x220000
                });
                this.directionArrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
                this.directionArrow.position.set(0, -3, -8);
                this.scene.add(this.directionArrow);
                
                // Create path line
                const pathGeometry = new THREE.BufferGeometry();
                const pathMaterial = new THREE.LineBasicMaterial({ 
                    color: 0x00ff00,
                    linewidth: 5
                });
                this.pathLine = new THREE.Line(pathGeometry, pathMaterial);
                this.scene.add(this.pathLine);
                
                // Create floating particles around restroom
                this.createParticles();
            }
            
            createParticles() {
                const particleGeometry = new THREE.BufferGeometry();
                const particleCount = 50;
                const positions = new Float32Array(particleCount * 3);
                
                for (let i = 0; i < particleCount; i++) {
                    positions[i * 3] = (Math.random() - 0.5) * 20;
                    positions[i * 3 + 1] = Math.random() * 10;
                    positions[i * 3 + 2] = (Math.random() - 0.5) * 20;
                }
                
                particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                const particleMaterial = new THREE.PointsMaterial({
                    color: 0x00ffff,
                    size: 0.5,
                    transparent: true,
                    opacity: 0.6
                });
                
                const particles = new THREE.Points(particleGeometry, particleMaterial);
                this.scene.add(particles);
            }
            
            setupEventListeners() {
                window.addEventListener('resize', () => this.onWindowResize());
                
                if ('DeviceOrientationEvent' in window) {
                    window.addEventListener('deviceorientation', (e) => this.onDeviceOrientation(e));
                }
                
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    document.addEventListener('click', () => {
                        DeviceOrientationEvent.requestPermission()
                            .then(response => {
                                if (response !== 'granted') {
                                    console.warn('Device orientation permission denied');
                                }
                            })
                            .catch(console.error);
                    });
                }
            }
            
            calculateDestination(lat, lng) {
                const distance = 20; // 20 meters
                const bearing = Math.random() * 360;
                
                const R = 6371e3;
                const œÜ1 = lat * Math.PI / 180;
                const Œ¥ = distance / R;
                const Œ∏ = bearing * Math.PI / 180;
                
                const œÜ2 = Math.asin(Math.sin(œÜ1) * Math.cos(Œ¥) +
                                    Math.cos(œÜ1) * Math.sin(Œ¥) * Math.cos(Œ∏));
                
                const Œª2 = (lng * Math.PI / 180) + Math.atan2(
                    Math.sin(Œ∏) * Math.sin(Œ¥) * Math.cos(œÜ1),
                    Math.cos(Œ¥) - Math.sin(œÜ1) * Math.sin(œÜ2)
                );
                
                return {
                    lat: œÜ2 * 180 / Math.PI,
                    lng: Œª2 * 180 / Math.PI
                };
            }
            
            async startTracking() {
                try {
                    await this.getUserLocation();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('startButton').textContent = 'üîÑ Restart';
                    this.isActive = true;
                    
                    this.updateDisplay();
                    this.animate();
                    
                } catch (error) {
                    console.error('Error starting tracking:', error);
                    document.getElementById('loading').innerHTML = 
                        '<div style="color: red;">Error: ' + error.message + '</div>';
                }
            }
            
            async toggleCamera() {
                if (this.cameraMode) {
                    this.stopCamera();
                } else {
                    await this.startCamera();
                }
            }
            
            async startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });
                    
                    this.video.srcObject = stream;
                    await this.video.play();
                    
                    this.video.classList.add('active');
                    this.cameraMode = true;
                    
                    document.getElementById('cameraButton').textContent = 'üö´ Stop Camera';
                    document.getElementById('modeText').textContent = 'AR Camera Mode Active';
                    document.getElementById('noCameraMode').classList.add('hidden');
                    
                } catch (error) {
                    console.error('Camera access denied:', error);
                    this.cameraMode = false;
                }
            }
            
            stopCamera() {
                if (this.video.srcObject) {
                    this.video.srcObject.getTracks().forEach(track => track.stop());
                    this.video.srcObject = null;
                }
                
                this.video.classList.remove('active');
                this.cameraMode = false;
                
                document.getElementById('cameraButton').textContent = 'üì∑ AR Camera';
                document.getElementById('modeText').textContent = 'Map Mode Active';
            }
            
            toggleMode() {
                const noCameraMode = document.getElementById('noCameraMode');
                const modeToggle = document.getElementById('modeToggle');
                
                if (noCameraMode.classList.contains('hidden')) {
                    noCameraMode.classList.remove('hidden');
                    modeToggle.textContent = 'üéØ AR Mode';
                    this.stopCamera();
                } else {
                    noCameraMode.classList.add('hidden');
                    modeToggle.textContent = 'üì± Map Mode';
                }
            }
            
            async getUserLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }
                    
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    };
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.currentPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            
                            if (!this.destinationSet) {
                                this.initialPosition = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                };
                                
                                const destination = this.calculateDestination(
                                    this.initialPosition.lat,
                                    this.initialPosition.lng
                                );
                                
                                this.restroomLocation.lat = destination.lat;
                                this.restroomLocation.lng = destination.lng;
                                this.destinationSet = true;
                                
                                console.log('Destination set:', this.restroomLocation);
                            }
                            
                            this.updateNavigation();
                            resolve();
                        },
                        (error) => {
                            reject(new Error('Location access denied'));
                        },
                        options
                    );
                    
                    navigator.geolocation.watchPosition(
                        (position) => {
                            this.currentPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            this.updateNavigation();
                        },
                        (error) => console.warn('Position watch error:', error),
                        options
                    );
                });
            }
            
            onDeviceOrientation(event) {
                this.deviceOrientation = {
                    alpha: event.alpha || 0,
                    beta: event.beta || 0,
                    gamma: event.gamma || 0
                };
                
                this.compassHeading = event.alpha ? (360 - event.alpha) % 360 : 0;
                
                if (this.camera && this.cameraMode) {
                    const alpha = THREE.MathUtils.degToRad(this.deviceOrientation.alpha || 0);
                    const beta = THREE.MathUtils.degToRad(this.deviceOrientation.beta || 0);
                    const gamma = THREE.MathUtils.degToRad(this.deviceOrientation.gamma || 0);
                    
                    this.camera.rotation.set(beta, alpha, gamma);
                }
                
                this.updateCompass();
            }
            
            updateNavigation() {
                if (!this.destinationSet) return;
                
                this.currentDistance = this.calculateDistance(
                    this.currentPosition.lat,
                    this.currentPosition.lng,
                    this.restroomLocation.lat,
                    this.restroomLocation.lng
                );
                
                this.targetBearing = this.calculateBearing(
                    this.currentPosition.lat,
                    this.currentPosition.lng,
                    this.restroomLocation.lat,
                    this.restroomLocation.lng
                );
                
                this.updateDisplay();
                this.update3DObjects();
                
                if (this.currentDistance < 5 && !this.hasArrived) {
                    this.triggerArrival();
                }
            }
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3;
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
                
                const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                         Math.cos(œÜ1) * Math.cos(œÜ2) *
                         Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                
                return R * c;
            }
            
            calculateBearing(lat1, lon1, lat2, lon2) {
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
                
                const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
                const x = Math.cos(œÜ1) * Math.sin(œÜ2) - Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
                
                const Œ∏ = Math.atan2(y, x);
                
                return (Œ∏ * 180 / Math.PI + 360) % 360;
            }
            
            updateDisplay() {
                const distanceDisplay = document.getElementById('distanceDisplay');
                const directionDisplay = document.getElementById('directionDisplay');
                const coordinates = document.getElementById('coordinates');
                const radarInfo = document.getElementById('radarInfo');
                const radarDot = document.getElementById('radarDot');
                
                // Update main display
                distanceDisplay.textContent = `üöª Restroom: ${this.currentDistance.toFixed(1)}m away`;
                
                const relativeBearing = (this.targetBearing - this.compassHeading + 360) % 360;
                let direction = '';
                let directionColor = '#ffffff';
                
                if (relativeBearing < 20 || relativeBearing > 340) {
                    direction = '‚¨ÜÔ∏è Straight ahead';
                    directionColor = '#00ff00';
                } else if (relativeBearing < 70) {
                    direction = '‚ÜóÔ∏è Turn slightly right';
                    directionColor = '#ffff00';
                } else if (relativeBearing < 110) {
                    direction = '‚û°Ô∏è Turn right';
                    directionColor = '#ff8800';
                } else if (relativeBearing < 160) {
                    direction = '‚ÜòÔ∏è Turn sharp right';
                    directionColor = '#ff4400';
                } else if (relativeBearing < 200) {
                    direction = '‚¨áÔ∏è Turn around';
                    directionColor = '#ff0000';
                } else if (relativeBearing < 250) {
                    direction = '‚ÜôÔ∏è Turn sharp left';
                    directionColor = '#ff4400';
                } else if (relativeBearing < 290) {
                    direction = '‚¨ÖÔ∏è Turn left';
                    directionColor = '#ff8800';
                } else {
                    direction = '‚ÜñÔ∏è Turn slightly left';
                    directionColor = '#ffff00';
                }
                
                directionDisplay.textContent = direction;
                directionDisplay.style.color = directionColor;
                
                // Update coordinates
                coordinates.textContent = 
                    `GPS: ${this.currentPosition.lat.toFixed(6)}, ${this.currentPosition.lng.toFixed(6)} ` +
                    `| Target: ${this.restroomLocation.lat.toFixed(6)}, ${this.restroomLocation.lng.toFixed(6)} ` +
                    `| Accuracy: ¬±${this.currentPosition.accuracy.toFixed(0)}m`;
                
                // Update radar display
                if (radarInfo) {
                    radarInfo.textContent = `Distance: ${this.currentDistance.toFixed(1)}m | ${direction}`;
                }
                
                // Update radar dot position
                if (radarDot) {
                    const maxRadius = 90; // Max radar radius
                    const distance = Math.min(this.currentDistance, 50);
                    const radius = (distance / 50) * maxRadius;
                    
                    const angle = relativeBearing * Math.PI / 180;
                    const x = Math.sin(angle) * radius;
                    const y = -Math.cos(angle) * radius;
                    
                    radarDot.style.transform = `translate(${x + 50}%, ${y + 50}%)`;
                    
                    // Change color based on distance
                    if (this.currentDistance < 10) {
                        radarDot.style.background = '#00ff00';
                    } else if (this.currentDistance < 20) {
                        radarDot.style.background = '#ffff00';
                    } else {
                        radarDot.style.background = '#ff0000';
                    }
                }
            }
            
            updateCompass() {
                const needle = document.getElementById('compassNeedle');
                const bearingDiff = this.targetBearing - this.compassHeading;
                needle.style.transform = `translate(-50%, -100%) rotate(${bearingDiff}deg)`;
            }
            
            update3DObjects() {
                if (!this.restroomSymbol || !this.directionArrow) return;
                
                // Position restroom symbol based on distance and bearing
                const distance = Math.min(this.currentDistance, 100);
                const bearing = THREE.MathUtils.degToRad(this.targetBearing - this.compassHeading);
                
                const x = Math.sin(bearing) * distance;
                const z = -Math.cos(bearing) * distance;
                
                this.restroomSymbol.position.set(x, 0, z);
                
                // Scale based on distance - closer = bigger
                const baseScale = Math.max(0.5, Math.min(3, 100 / this.currentDistance));
                this.restroomSymbol.scale.set(baseScale, baseScale, baseScale);
                
                // Add bouncing animation
                const time = Date.now() * 0.003;
                const bounce = Math.sin(time) * 2;
                this.restroomSymbol.position.y = bounce;
                
                // Rotate the symbol slowly
                this.restroomSymbol.rotation.y += 0.01;
                
                // Update direction arrow
                this.directionArrow.lookAt(this.restroomSymbol.position);
                this.directionArrow.position.y = -3 + Math.sin(time * 2) * 0.5;
                
                // Pulse effect when very close
                if (this.currentDistance < 15) {
                    const pulseScale = 1 + 0.5 * Math.sin(time * 2);
                    this.restroomSymbol.scale.multiplyScalar(pulseScale);
                    
                    // Change color when close
                    this.restroomSymbol.children.forEach(child => {
                        if (child.material) {
                            child.material.emissive.setHex(0x002200);
                        }
                    });
                }
                
                // Update path line
                this.updatePathLine();
            }
            
            updatePathLine() {
                if (!this.pathLine) return;
                
                const points = [];
                const steps = 20;
                
                for (let i = 0; i <= steps; i++) {
                    const t = i / steps;
                    const x = Math.sin(THREE.MathUtils.degToRad(this.targetBearing - this.compassHeading)) * t * this.currentDistance;
                    const z = -Math.cos(THREE.MathUtils.degToRad(this.targetBearing - this.compassHeading)) * t * this.currentDistance;
                    const y = Math.sin(t * Math.PI) * 2; // Arc shape
                    
                    points.push(new THREE.Vector3(x, y, z));
                }
                
                this.pathLine.geometry.setFromPoints(points);
            }
            
            triggerArrival() {
                this.hasArrived = true;
                const arrivedMessage = document.getElementById('arrivedMessage');
                arrivedMessage.style.display = 'block';
                
                // Play celebration sound
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('Congratulations! You have arrived at the restroom!');
                    utterance.pitch = 1.2;
                    utterance.rate = 1.1;
                    speechSynthesis.speak(utterance);
                }
                
                // Fireworks effect in 3D
                this.createFireworks();
                
                // Hide message after 6 seconds
                setTimeout(() => {
                    arrivedMessage.style.display = 'none';
                }, 6000);
            }
            
            createFireworks() {
                const fireworksGeometry = new THREE.BufferGeometry();
                const fireworksCount = 100;
                const positions = new Float32Array(fireworksCount * 3);
                const colors = new Float32Array(fireworksCount * 3);
                
                for (let i = 0; i < fireworksCount; i++) {
                    positions[i * 3] = (Math.random() - 0.5) * 50;
                    positions[i * 3 + 1] = Math.random() * 20 + 5;
                    positions[i * 3 + 2] = (Math.random() - 0.5) * 50;
                    
                    colors[i * 3] = Math.random();
                    colors[i * 3 + 1] = Math.random();
                    colors[i * 3 + 2] = Math.random();
                }
                
                fireworksGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                fireworksGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                
                const fireworksMaterial = new THREE.PointsMaterial({
                    size: 3,
                    transparent: true,
                    opacity: 0.8,
                    vertexColors: true
                });
                
                const fireworks = new THREE.Points(fireworksGeometry, fireworksMaterial);
                this.scene.add(fireworks);
                
                // Remove fireworks after 3 seconds
                setTimeout(() => {
                    this.scene.remove(fireworks);
                }, 3000);
            }
            
            animate() {
                if (!this.isActive) return;
                
                this.animationId = requestAnimationFrame(() => this.animate());
                
                this.update3DObjects();
                this.renderer.render(this.scene, this.camera);
            }
            
            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            stop() {
                this.isActive = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                this.stopCamera();
            }
        }
        
        // Initialize Enhanced AR system
        const arLocator = new EnhancedARRestroomLocator();
        
        // Global functions
        function startTracking() {
            arLocator.startTracking();
        }
        
        function toggleCamera() {
            arLocator.toggleCamera();
        }
        
        function toggleMode() {
            arLocator.toggleMode();
        }
        
        // Auto-start location tracking on page load
        window.addEventListener('load', () => {
            // Small delay to ensure everything is loaded
            setTimeout(() => {
                startTracking();
            }, 1000);
        });
    </script>
</body>
</html>