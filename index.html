<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real AR Restroom Locator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }
        
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            pointer-events: none;
        }
        
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 3;
            pointer-events: none;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        
        .distance-display {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .direction-display {
            font-size: 16px;
            text-align: center;
            margin-bottom: 15px;
            color: #ffffff;
        }
        
        .compass-container {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 100px;
            height: 100px;
            border: 3px solid rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 40px;
            background: linear-gradient(to top, #ff0000, #ff6666);
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        .compass-labels {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .compass-n { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); }
        .compass-e { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); }
        .compass-s { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); }
        .compass-w { position: absolute; left: 5px; top: 50%; transform: translateY(-50%); }
        
        .navigation-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(0, 255, 0, 0.3);
            text-align: center;
        }
        
        .coordinates {
            font-size: 14px;
            margin-top: 10px;
            color: #888;
        }
        
        .start-button {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .start-button:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.5);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            text-align: center;
            z-index: 10;
        }
        
        .arrived-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 255, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            display: none;
            z-index: 10;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); }
            50% { box-shadow: 0 0 30px rgba(0, 255, 255, 0.8); }
        }
        
        .pulse { animation: pulse 2s infinite; }
        .glow { animation: glow 2s infinite; }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>ðŸš€ Initializing AR Camera...</div>
        <div style="font-size: 14px; margin-top: 10px;">Please allow camera and location access</div>
    </div>
    
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    
    <div class="ui-overlay">
        <div class="info-panel">
            <div class="distance-display" id="distanceDisplay">ðŸš» Restroom: Locating...</div>
            <div class="direction-display" id="directionDisplay">Initializing compass...</div>
        </div>
        
        <div class="compass-container" id="compassContainer">
            <div class="compass-needle" id="compassNeedle"></div>
            <div class="compass-labels">
                <div class="compass-n">N</div>
                <div class="compass-e">E</div>
                <div class="compass-s">S</div>
                <div class="compass-w">W</div>
            </div>
        </div>
        
        <div class="navigation-info" id="navigationInfo">
            <div>Move your phone to look around</div>
            <div class="coordinates" id="coordinates">Waiting for GPS...</div>
        </div>
        
        <button class="start-button" id="startButton" onclick="startAR()">ðŸš€ Start AR Navigation</button>
    </div>
    
    <div class="arrived-message" id="arrivedMessage">
        ðŸŽ‰ ARRIVED! ðŸŽ‰<br>
        <div style="font-size: 16px; margin-top: 10px;">Welcome to the restroom!</div>
    </div>

    <script>
        class ARRestroomLocator {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.video = null;
                this.canvas = null;
                
                // Real device sensors
                this.currentPosition = { lat: 0, lng: 0, accuracy: 0 };
                this.deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
                this.compassHeading = 0;
                
                // Restroom location (example coordinates - replace with actual)
                this.restroomLocation = {
                    lat: 37.7749,  // Replace with actual restroom latitude
                    lng: -122.4194, // Replace with actual restroom longitude
                    name: "Main Restroom"
                };
                
                // 3D objects
                this.restroomMarker = null;
                this.directionArrow = null;
                this.pathLine = null;
                
                // State
                this.isActive = false;
                this.currentDistance = 0;
                this.targetBearing = 0;
                this.hasArrived = false;
                
                this.init();
            }
            
            init() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.setupThreeJS();
                this.setupEventListeners();
            }
            
            setupThreeJS() {
                // Create scene
                this.scene = new THREE.Scene();
                
                // Create camera
                this.camera = new THREE.PerspectiveCamera(
                    75, 
                    window.innerWidth / window.innerHeight, 
                    0.1, 
                    1000
                );
                
                // Create renderer
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: this.canvas,
                    alpha: true,
                    antialias: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setClearColor(0x000000, 0);
                
                // Add lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(0, 1, 0);
                this.scene.add(directionalLight);
                
                this.create3DObjects();
            }
            
            create3DObjects() {
                // Create restroom marker (3D toilet icon)
                const markerGeometry = new THREE.BoxGeometry(2, 3, 1);
                const markerMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x00ffff,
                    transparent: true,
                    opacity: 0.8
                });
                this.restroomMarker = new THREE.Mesh(markerGeometry, markerMaterial);
                this.scene.add(this.restroomMarker);
                
                // Create direction arrow
                const arrowGeometry = new THREE.ConeGeometry(0.5, 2, 8);
                const arrowMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });
                this.directionArrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
                this.directionArrow.position.set(0, -2, -5);
                this.scene.add(this.directionArrow);
                
                // Create path line
                const pathGeometry = new THREE.BufferGeometry();
                const pathMaterial = new THREE.LineBasicMaterial({ 
                    color: 0x00ff00,
                    linewidth: 3
                });
                this.pathLine = new THREE.Line(pathGeometry, pathMaterial);
                this.scene.add(this.pathLine);
            }
            
            setupEventListeners() {
                window.addEventListener('resize', () => this.onWindowResize());
                
                // Device orientation
                if ('DeviceOrientationEvent' in window) {
                    window.addEventListener('deviceorientation', (e) => this.onDeviceOrientation(e));
                }
                
                // Request orientation permission for iOS
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    document.addEventListener('click', () => {
                        DeviceOrientationEvent.requestPermission()
                            .then(response => {
                                if (response !== 'granted') {
                                    console.warn('Device orientation permission denied');
                                }
                            })
                            .catch(console.error);
                    });
                }
            }
            
            async startAR() {
                try {
                    // Get user location
                    await this.getUserLocation();
                    
                    // Start camera
                    await this.startCamera();
                    
                    // Start AR tracking
                    this.startTracking();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('startButton').style.display = 'none';
                    this.isActive = true;
                    
                } catch (error) {
                    console.error('Error starting AR:', error);
                    document.getElementById('loading').innerHTML = 
                        '<div style="color: red;">Error: ' + error.message + '</div>';
                }
            }
            
            async getUserLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }
                    
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    };
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.currentPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            
                            // Calculate initial distance and bearing
                            this.updateNavigation();
                            resolve();
                        },
                        (error) => {
                            reject(new Error('Location access denied or unavailable'));
                        },
                        options
                    );
                    
                    // Watch position changes
                    navigator.geolocation.watchPosition(
                        (position) => {
                            this.currentPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            this.updateNavigation();
                        },
                        null,
                        options
                    );
                });
            }
            
            async startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });
                    
                    this.video.srcObject = stream;
                    await this.video.play();
                    
                } catch (error) {
                    throw new Error('Camera access denied');
                }
            }
            
            startTracking() {
                this.animate();
            }
            
            onDeviceOrientation(event) {
                this.deviceOrientation = {
                    alpha: event.alpha || 0,
                    beta: event.beta || 0,
                    gamma: event.gamma || 0
                };
                
                // Calculate compass heading
                this.compassHeading = event.alpha ? (360 - event.alpha) % 360 : 0;
                
                // Update camera rotation based on device orientation
                if (this.camera) {
                    const alpha = THREE.MathUtils.degToRad(this.deviceOrientation.alpha || 0);
                    const beta = THREE.MathUtils.degToRad(this.deviceOrientation.beta || 0);
                    const gamma = THREE.MathUtils.degToRad(this.deviceOrientation.gamma || 0);
                    
                    this.camera.rotation.set(beta, alpha, gamma);
                }
                
                this.updateCompass();
            }
            
            updateNavigation() {
                // Calculate distance and bearing to restroom
                this.currentDistance = this.calculateDistance(
                    this.currentPosition.lat,
                    this.currentPosition.lng,
                    this.restroomLocation.lat,
                    this.restroomLocation.lng
                );
                
                this.targetBearing = this.calculateBearing(
                    this.currentPosition.lat,
                    this.currentPosition.lng,
                    this.restroomLocation.lat,
                    this.restroomLocation.lng
                );
                
                this.updateUI();
                this.update3DObjects();
                
                // Check if arrived
                if (this.currentDistance < 5 && !this.hasArrived) {
                    this.triggerArrival();
                }
            }
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Earth's radius in meters
                const Ï†1 = lat1 * Math.PI / 180;
                const Ï†2 = lat2 * Math.PI / 180;
                const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
                const Î”Î» = (lon2 - lon1) * Math.PI / 180;
                
                const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                         Math.cos(Ï†1) * Math.cos(Ï†2) *
                         Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                
                return R * c;
            }
            
            calculateBearing(lat1, lon1, lat2, lon2) {
                const Ï†1 = lat1 * Math.PI / 180;
                const Ï†2 = lat2 * Math.PI / 180;
                const Î”Î» = (lon2 - lon1) * Math.PI / 180;
                
                const y = Math.sin(Î”Î») * Math.cos(Ï†2);
                const x = Math.cos(Ï†1) * Math.sin(Ï†2) - Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
                
                const Î¸ = Math.atan2(y, x);
                
                return (Î¸ * 180 / Math.PI + 360) % 360;
            }
            
            updateUI() {
                const distanceDisplay = document.getElementById('distanceDisplay');
                const directionDisplay = document.getElementById('directionDisplay');
                const coordinates = document.getElementById('coordinates');
                
                distanceDisplay.textContent = `ðŸš» Restroom: ${this.currentDistance.toFixed(1)}m away`;
                
                const relativeBearing = (this.targetBearing - this.compassHeading + 360) % 360;
                let direction = '';
                
                if (relativeBearing < 15 || relativeBearing > 345) {
                    direction = 'Straight ahead';
                    directionDisplay.style.color = '#00ff00';
                } else if (relativeBearing < 45) {
                    direction = 'Turn slightly right';
                    directionDisplay.style.color = '#ffff00';
                } else if (relativeBearing < 135) {
                    direction = 'Turn right';
                    directionDisplay.style.color = '#ff8800';
                } else if (relativeBearing < 225) {
                    direction = 'Turn around';
                    directionDisplay.style.color = '#ff0000';
                } else if (relativeBearing < 315) {
                    direction = 'Turn left';
                    directionDisplay.style.color = '#ff8800';
                } else {
                    direction = 'Turn slightly left';
                    directionDisplay.style.color = '#ffff00';
                }
                
                directionDisplay.textContent = direction;
                
                coordinates.textContent = 
                    `Lat: ${this.currentPosition.lat.toFixed(6)}, ` +
                    `Lng: ${this.currentPosition.lng.toFixed(6)} ` +
                    `(Â±${this.currentPosition.accuracy.toFixed(0)}m)`;
            }
            
            updateCompass() {
                const needle = document.getElementById('compassNeedle');
                const bearingDiff = this.targetBearing - this.compassHeading;
                needle.style.transform = `translate(-50%, -100%) rotate(${bearingDiff}deg)`;
            }
            
            update3DObjects() {
                if (!this.restroomMarker || !this.directionArrow) return;
                
                // Position restroom marker based on distance and bearing
                const distance = Math.min(this.currentDistance, 50); // Clamp max distance for visibility
                const bearing = THREE.MathUtils.degToRad(this.targetBearing - this.compassHeading);
                
                const x = Math.sin(bearing) * distance;
                const z = -Math.cos(bearing) * distance;
                
                this.restroomMarker.position.set(x, 0, z);
                
                // Scale marker based on distance
                const scale = Math.max(0.5, Math.min(2, 50 / this.currentDistance));
                this.restroomMarker.scale.set(scale, scale, scale);
                
                // Update direction arrow
                this.directionArrow.lookAt(this.restroomMarker.position);
                
                // Make objects pulse when close
                if (this.currentDistance < 20) {
                    const pulseScale = 1 + 0.3 * Math.sin(Date.now() * 0.005);
                    this.restroomMarker.scale.multiplyScalar(pulseScale);
                }
            }
            
            triggerArrival() {
                this.hasArrived = true;
                const arrivedMessage = document.getElementById('arrivedMessage');
                arrivedMessage.style.display = 'block';
                
                // Play arrival sound
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('You have arrived at the restroom!');
                    speechSynthesis.speak(utterance);
                }
                
                // Hide arrival message after 5 seconds
                setTimeout(() => {
                    arrivedMessage.style.display = 'none';
                }, 5000);
            }
            
            animate() {
                if (!this.isActive) return;
                
                requestAnimationFrame(() => this.animate());
                
                // Update 3D objects
                this.update3DObjects();
                
                // Render scene
                this.renderer.render(this.scene, this.camera);
            }
            
            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }
        
        // Initialize AR system
        const arLocator = new ARRestroomLocator();
        
        // Global function for start button
        function startAR() {
            arLocator.startAR();
        }
    </script>
</body>
</html>